import asyncio
import logging
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import Message
from aiogram.enums import ParseMode, ChatAction
from aiogram.utils.markdown import hbold
from g4f.client import Client
from typing import List, Dict, Set
from datetime import datetime
import os
from dotenv import load_dotenv

# Load environment variables
load_dotenv()
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")

# Enable logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

class GPTService:
    def __init__(self):
        self.client = Client()
        self.conversations: Dict[int, List[Dict]] = {}
        self.max_history = 10
        
        self.system_prompt = """–í—ã —è–≤–ª—è–µ—Ç–µ—Å—å –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã Expera. –í–∞—à–∞ –æ—Å–Ω–æ–≤–Ω–∞—è —Ä–æ–ª—å - –ø–æ–º–æ–≥–∞—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞–º –≤ –∏—Ö –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–º –ø—É—Ç–∏, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—É—Ä—Å–∞—Ö –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏—Ö –º–æ—Ç–∏–≤–∞—Ü–∏—é –∏ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å. –°–ª–µ–¥—É–π—Ç–µ —ç—Ç–∏–º –∫–ª—é—á–µ–≤—ã–º –ø—Ä–∏–Ω—Ü–∏–ø–∞–º –≤ –æ–±—â–µ–Ω–∏–∏:

–õ–ò–ß–ù–û–°–¢–¨ –ò –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –ë—É–¥—å—Ç–µ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º –∏ –æ–±–æ–¥—Ä—è—é—â–∏–º
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π —è–∑—ã–∫ –∏ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ç–æ–Ω
- –ü—Ä–æ—è–≤–ª—è–π—Ç–µ —ç–Ω—Ç—É–∑–∏–∞–∑–º –∫ –æ–±—É—á–µ–Ω–∏—é –∏ —É—Å–ø–µ—Ö–∞–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
- –ü–∏—à–∏—Ç–µ –ø—Ä–æ—Å—Ç—ã–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º —è–∑—ã–∫–æ–º, –ø–æ–¥—Ö–æ–¥—è—â–∏–º –¥–ª—è —É—á–∞—â–∏—Ö—Å—è
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–º–µ—Å—Ç–Ω—ã–µ —ç–º–æ–¥–∑–∏ –¥–ª—è –≤–æ–≤–ª–µ—á–µ–Ω–∏—è –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä üìö‚ú®

–û–°–ù–û–í–ù–´–ï –û–ë–Ø–ó–ê–ù–ù–û–°–¢–ò:

1. –ú–û–¢–ò–í–ê–¶–ò–û–ù–ù–ê–Ø –ü–û–î–î–ï–†–ñ–ö–ê:
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –§–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ —Ä–∞–∑–≤–∏—Ç–∏–∏ –º—ã—à–ª–µ–Ω–∏—è –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –≤ –æ–±—É—á–µ–Ω–∏–∏
- –î–µ–ª–∏—Ç–µ—Å—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ –∏—Å—Ç–æ—Ä–∏—è–º–∏ —É—Å–ø–µ—Ö–∞ –∏ —Å–æ–≤–µ—Ç–∞–º–∏ –ø–æ –æ–±—É—á–µ–Ω–∏—é
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±–æ–¥—Ä—è—é—â–∏–µ —Ñ—Ä–∞–∑—ã –∏ –æ—Ç–º–µ—á–∞–π—Ç–µ –º–∞–ª–µ–Ω—å–∫–∏–µ –ø–æ–±–µ–¥—ã
- –ó–∞–ø–æ–º–∏–Ω–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ —É–ø–æ–º–∏–Ω–∞–π—Ç–µ –µ–≥–æ –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞—Ö

2. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ö–£–†–°–ê–ú:
- –ó–∞–¥–∞–≤–∞–π—Ç–µ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ:
  * –¢–µ–∫—É—â–µ–º —É—Ä–æ–≤–Ω–µ –∑–Ω–∞–Ω–∏–π
  * –¶–µ–ª—è—Ö –æ–±—É—á–µ–Ω–∏—è
  * –î–æ—Å—Ç—É–ø–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
  * –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ–º —Å—Ç–∏–ª–µ –æ–±—É—á–µ–Ω–∏—è
  * –ë—é–¥–∂–µ—Ç–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö

3. –ü–û–î–î–ï–†–ñ–ö–ê –í –û–ë–£–ß–ï–ù–ò–ò:
- –û—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–∏ –∫—É—Ä—Å–æ–≤ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö
- –û–±—ä—è—Å–Ω—è–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ —Ç–µ–º—ã –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
- –†–∞–∑–±–∏–≤–∞–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –Ω–∞ —É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ —á–∞—Å—Ç–∏
- –ü—Ä–∏–≤–æ–¥–∏—Ç–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏ –∞–Ω–∞–ª–æ–≥–∏–∏
- –ù–∞–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —Ä–µ—Å—É—Ä—Å–∞–º

4. –ö–†–£–ì–õ–û–°–£–¢–û–ß–ù–ê–Ø –ü–û–î–î–ï–†–ñ–ö–ê:
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –ø–æ–º–æ—â—å 24/7 –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º:
  * –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º
  * –î–æ—Å—Ç—É–ø–∞ –∫ –∫—É—Ä—Å–∞–º
  * –†–∞–∑—ä—è—Å–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π
  * –û–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
- –í–µ–¥–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
- –ó–Ω–∞–π—Ç–µ, –∫–æ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å —á–µ–ª–æ–≤–µ–∫—É-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π —Å–≤—è–∑–∏

5. –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ê–°–ü–ò–°–ê–ù–ò–ï–ú:
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∏ –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–π—Ç–µ –æ:
  * –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –∑–∞–Ω—è—Ç–∏—è—Ö
  * –î–µ–¥–ª–∞–π–Ω–∞—Ö –∑–∞–¥–∞–Ω–∏–π
  * –î–∞—Ç–∞—Ö –Ω–∞—á–∞–ª–∞ –∫—É—Ä—Å–æ–≤
  * –†–∞—Å–ø–∏—Å–∞–Ω–∏–∏ —ç–∫–∑–∞–º–µ–Ω–æ–≤
- –û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- –ü–æ–º–æ–≥–∞–π—Ç–µ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏ –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏
- –ü—Ä–µ–¥–ª–∞–≥–∞–π—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–û–í:
1. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
2. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ —á–µ—Ç–∫—É—é, —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
3. –î–æ–±–∞–≤—å—Ç–µ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç, –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ
4. –£–∫–∞–∂–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è
5. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø–æ–º–æ—â—å

–ë–ê–ó–ê –ó–ù–ê–ù–ò–ô:
- –ö–∞—Ç–∞–ª–æ–≥ –∫—É—Ä—Å–æ–≤
- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∑–∞–Ω—è—Ç–∏–π
- –¶–µ–Ω—ã –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ–ø–ª–∞—Ç—ã
- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- –†–µ—Å—É—Ä—Å—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏

–û–°–û–ë–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò:
1. –ü—Ä–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –¥–∞—Ç—É, –≤—Ä–µ–º—è –∏ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
2. –î–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∫—É—Ä—Å–æ–≤ –≤—Å–µ–≥–¥–∞ –æ–±—ä—è—Å–Ω—è–π—Ç–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –æ–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
3. –ü—Ä–∏ —Ä–µ—à–µ–Ω–∏–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
4. –í–∫–ª—é—á–∞–π—Ç–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —É—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏–ª–∏ —Ä–µ—Å—É—Ä—Å—ã, –∫–æ–≥–¥–∞ —ç—Ç–æ –ø—Ä–∏–º–µ–Ω–∏–º–æ
5. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –∏ —Å—Å—ã–ª–∞–π—Ç–µ—Å—å –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
6. –í—Å–µ–≥–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–π—Ç–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º —Ä–µ—à–µ–Ω–∏–π

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –û–¢–í–ï–¢–´:

–î–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –æ –∫—É—Ä—Å–∞—Ö:
"[–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞] —Ç—Ä–µ–±—É–µ—Ç [–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è]. –£—á–∏—Ç—ã–≤–∞—è –≤–∞—à –æ–ø—ã—Ç –≤ [—É–ø–æ–º—è–Ω—É—Ç—ã–π –æ–ø—ã—Ç], —è —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –Ω–∞—á–∞—Ç—å —Å [–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å/–∫—É—Ä—Å]. –ö—É—Ä—Å –≤–∫–ª—é—á–∞–µ—Ç [–∫–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã] –∏ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –¥–æ—Å—Ç–∏—á—å [–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–µ–ª–∏]."

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏:
"–°–ª–µ–¥—É—é—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ –ø–æ [–ø—Ä–µ–¥–º–µ—Ç] —É—Ä–æ–≤–Ω—è [—É—Ä–æ–≤–µ–Ω—å] —Å–æ—Å—Ç–æ–∏—Ç—Å—è [–¥–∞—Ç–∞/–≤—Ä–µ–º—è]. –•–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã —è –Ω–∞–ø–æ–º–Ω–∏–ª –≤–∞–º –æ–± —ç—Ç–æ–º –∑–∞ —á–∞—Å –¥–æ –Ω–∞—á–∞–ª–∞?"

–î–ª—è –º–æ—Ç–∏–≤–∞—Ü–∏–∏:
"üåü [–ò–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞], –≤—ã –æ—Ç–ª–∏—á–Ω–æ –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç–µ—Å—å –≤ –∏–∑—É—á–µ–Ω–∏–∏ [–ø—Ä–µ–¥–º–µ—Ç]! –£–∂–µ –ø—Ä–æ–π–¥–µ–Ω–æ [X] —É—Ä–æ–∫–æ–≤, –∏ —è –≤–∏–∂—É –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ [–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –Ω–∞–≤—ã–∫]. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!"

–î–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏:
"–î–∞–≤–∞–π—Ç–µ —Ä–µ—à–∏–º —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É –ø–æ—à–∞–≥–æ–≤–æ. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ [–ø–µ—Ä–≤—ã–π —à–∞–≥]. –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ [—Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥]. –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å –≤–∞–º –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ."

–û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö:
- –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –æ–±—ä—è—Å–Ω–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
- –ï—Å–ª–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ –ø—Ä–µ–≤—ã—à–∞—é—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞, –∑–Ω–∞–π—Ç–µ, –∫–∞–∫ —Å–≤—è–∑–∞—Ç—å –µ–≥–æ —Å —á–µ–ª–æ–≤–µ–∫–æ–º-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º
- –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ

–ü–æ–º–Ω–∏—Ç–µ:
- –î–µ—Ä–∂–∏—Ç–µ –æ—Ç–≤–µ—Ç—ã –∫—Ä–∞—Ç–∫–∏–º–∏, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–µ –ø–æ–¥–∫—Ä–µ–ø–ª–µ–Ω–∏–µ
- –û—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –≤ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
- –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä—É–π—Ç–µ —É—Å–ø–µ—Ö –∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π —ç–Ω—Ç—É–∑–∏–∞–∑–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É"""

    def add_message_to_history(self, chat_id: int, role: str, content: str) -> None:
        if chat_id not in self.conversations:
            self.conversations[chat_id] = []

        self.conversations[chat_id].append({
            "role": role,
            "content": content,
            "timestamp": datetime.now().isoformat()
        })

        if len(self.conversations[chat_id]) > self.max_history:
            self.conversations[chat_id] = self.conversations[chat_id][-self.max_history:]

    def format_messages_for_g4f(self, chat_id: int) -> List[Dict[str, str]]:
        messages = [
            {"role": "system", "content": self.system_prompt}
        ]
        
        for msg in self.conversations.get(chat_id, []):
            messages.append({
                "role": msg["role"],
                "content": msg["content"]
            })
            
        return messages

    async def get_gpt_response(self, chat_id: int, user_message: str) -> str:
        try:
            self.add_message_to_history(chat_id, "user", user_message)
            messages = self.format_messages_for_g4f(chat_id)
            
            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=messages,
                temperature=0.7,
                max_tokens=2000
            )
            
            response_text = response.choices[0].message.content.strip()
            self.add_message_to_history(chat_id, "assistant", response_text)
            
            return response_text

        except Exception as e:
            logger.error(f"Error getting GPT response: {str(e)}")
            raise

    def clear_history(self, chat_id: int) -> None:
        self.conversations[chat_id] = []

# Initialize bot and dispatcher
bot = Bot(token=TELEGRAM_TOKEN)
dp = Dispatcher()
gpt_service = GPTService()

# Set of active users for motivational messages
active_users: Set[int] = set()

# Motivational messages task
async def send_motivational_messages():
    while True:
        try:
            for chat_id in active_users:
                try:
                    motivation_request = "Generate a short, personalized motivational message for a student learning new skills. Make it inspiring and concise."
                    response = await gpt_service.get_gpt_response(chat_id, motivation_request)
                    await bot.send_message(chat_id, response)
                except Exception as e:
                    logger.error(f"Error sending motivation to {chat_id}: {e}")
            
            await asyncio.sleep(120)  # 2 minutes
        except Exception as e:
            logger.error(f"Motivation task error: {e}")
            await asyncio.sleep(5)

@dp.message(Command("start"))
async def cmd_start(message: Message):
    kb = [
        [
            types.KeyboardButton(text="/subscribe"),
            types.KeyboardButton(text="/unsubscribe")
        ],
        [
            types.KeyboardButton(text="/clear"),
            types.KeyboardButton(text="/help")
        ]
    ]
    keyboard = types.ReplyKeyboardMarkup(
        keyboard=kb,
        resize_keyboard=True,
        input_field_placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..."
    )
    
    welcome_text = (
        f"üëã –ü—Ä–∏–≤–µ—Ç, {hbold(message.from_user.first_name)}!\n\n"
        "–Ø –≤–∞—à –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ü–æ–º–æ–≥—É –≤–∞–º —Å:\n"
        "‚Ä¢ –ü–æ–¥–±–æ—Ä–æ–º –∫—É—Ä—Å–æ–≤\n"
        "‚Ä¢ –û—Ç–≤–µ—Ç–∞–º–∏ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã\n"
        "‚Ä¢ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –∑–∞–Ω—è—Ç–∏–π\n"
        "‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–æ–π 24/7\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/subscribe - –ø–æ–ª—É—á–∞—Ç—å –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n"
        "/unsubscribe - –æ—Ç–∫–ª—é—á–∏—Ç—å –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n"
        "/clear - –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞\n"
        "/help - –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏"
    )
    
    await message.answer(
        welcome_text,
        parse_mode=ParseMode.HTML,
        reply_markup=keyboard
    )

@dp.message(Command("subscribe"))
async def cmd_subscribe(message: Message):
    chat_id = message.chat.id
    if chat_id not in active_users:
        active_users.add(chat_id)
        await message.answer("‚ú® –í—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è! –Ø –±—É–¥—É –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤–∞—à –Ω–∞—Å—Ç—Ä–æ–π –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã.")
    else:
        await message.answer("–í—ã —É–∂–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.")

@dp.message(Command("unsubscribe"))
async def cmd_unsubscribe(message: Message):
    chat_id = message.chat.id
    if chat_id in active_users:
        active_users.remove(chat_id)
        await message.answer("–í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞–¥–µ—é—Å—å, –æ–Ω–∏ –±—ã–ª–∏ –ø–æ–ª–µ–∑–Ω—ã!")
    else:
        await message.answer("–í—ã –Ω–µ –±—ã–ª–∏ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.")

@dp.message(Command("clear"))
async def cmd_clear(message: Message):
    try:
        gpt_service.clear_history(message.chat.id)
        await message.answer("‚ú® –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω–∞!")
    except Exception as e:
        logger.error(f"Error clearing history: {e}")
        await message.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏—Å—Ç–æ—Ä–∏–∏.")

@dp.message(Command("help"))
async def cmd_help(message: Message):
    help_text = """
üéì –í–æ—Ç —á—Ç–æ —è —É–º–µ—é:

1Ô∏è‚É£ –ü–æ–¥–±–æ—Ä –∫—É—Ä—Å–æ–≤
- –ó–∞–¥–∞–º –≤–æ–ø—Ä–æ—Å—ã –æ –≤–∞—à–∏—Ö —Ü–µ–ª—è—Ö
- –ü—Ä–µ–¥–ª–æ–∂—É –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∫—É—Ä—Å—ã
- –†–∞—Å—Å–∫–∞–∂—É –æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è—Ö

2Ô∏è‚É£ –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
- –û –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö –æ–±—É—á–µ–Ω–∏—è
- –û —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏
- –û —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è—Ö

3Ô∏è‚É£ –ú–æ—Ç–∏–≤–∞—Ü–∏—è
- –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ –æ–±—É—á–µ–Ω–∏–∏
- –°–æ–≤–µ—Ç—ã –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–º—É –æ–±—É—á–µ–Ω–∏—é

4Ô∏è‚É£ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–Ω—è—Ç–∏—è—Ö
- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

–ü—Ä–æ—Å—Ç–æ —Å–ø—Ä–æ—Å–∏—Ç–µ –º–µ–Ω—è –æ —á–µ–º —É–≥–æ–¥–Ω–æ, —Å–≤—è–∑–∞–Ω–Ω–æ–º —Å –æ–±—É—á–µ–Ω–∏–µ–º! üìö
"""
    await message.answer(help_text)

@dp.message()
async def process_message(message: Message):
    try:
        chat_id = message.chat.id
        user_message = message.text

        await bot.send_chat_action(chat_id=chat_id, action=ChatAction.TYPING)
        
        response = await gpt_service.get_gpt_response(chat_id, user_message)
        await message.answer(response)
        
    except Exception as e:
        logger.error(f"Error processing message: {e}")
        error_message = (
            "üòî –ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ –∫–æ–º–∞–Ω–¥–æ–π /clear"
        )
        await message.answer(error_message)

async def main():
    try:
        logger.info("Starting bot...")
        asyncio.create_task(send_motivational_messages())
        await dp.start_polling(bot)
    except Exception as e:
        logger.error(f"Critical error: {e}")
    finally:
        await bot.session.close()

if __name__ == '__main__':
    asyncio.run(main())